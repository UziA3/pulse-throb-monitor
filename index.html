<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Real-Time Pulse + Migraine Throb Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 2rem; }
    canvas { width: 100%; max-width: 800px; height: 300px; }
    button { margin: 1rem; padding: 1rem 2rem; font-size: 1rem; }
  </style>
</head>
<body>

<h2>Real-Time Pulse & Migraine Tracker</h2>
<button id="connectBtn">Connect Heart Rate Monitor</button>
<button id="markBtn" disabled>Mark Throb</button>
<canvas id="pulseChart"></canvas>
<button id="downloadBtn" disabled>Download Recording</button>

<script>
let heartRate = 0;
let pulseData = [];
let throbMarks = [];
let timestamps = [];
let startTime = Date.now();

const chartCtx = document.getElementById('pulseChart').getContext('2d');
const pulseChart = new Chart(chartCtx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [
      {
        label: 'Pulse (BPM)',
        data: [],
        borderColor: 'red',
        fill: false,
        tension: 0.3,
      },
      {
        label: 'Throb',
        data: [],
        pointBackgroundColor: 'blue',
        pointRadius: 6,
        showLine: false
      }
    ]
  },
  options: {
    animation: false,
    scales: {
      x: { title: { display: true, text: 'Time (s)' } },
      y: { title: { display: true, text: 'BPM' }, min: 40, max: 180 }
    }
  }
});

document.getElementById('connectBtn').onclick = async () => {
  try {
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ services: ['heart_rate'] }]
    });
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService('heart_rate');
    const char = await service.getCharacteristic('heart_rate_measurement');

    char.startNotifications();
    char.addEventListener('characteristicvaluechanged', handleHR);
    document.getElementById('markBtn').disabled = false;
    document.getElementById('downloadBtn').disabled = false;
  } catch (err) {
    alert('Bluetooth error: ' + err);
  }
};

function handleHR(event) {
  const value = event.target.value;
  const flags = value.getUint8(0);
  const rate16Bits = flags & 0x1;
  heartRate = rate16Bits ? value.getUint16(1, true) : value.getUint8(1);
  updatePulse(heartRate);
}

function updatePulse(bpm) {
  const now = (Date.now() - startTime) / 1000;
  pulseData.push({ t: now, v: bpm });
  if (pulseData.length > 60) pulseData.shift();

  pulseChart.data.labels = pulseData.map(p => p.t.toFixed(1));
  pulseChart.data.datasets[0].data = pulseData.map(p => p.v);
  pulseChart.data.datasets[1].data = throbMarks.map(t => {
    return { x: t, y: interpolatePulse(t) };
  });
  pulseChart.update();
}

document.getElementById('markBtn').onclick = () => {
  const now = (Date.now() - startTime) / 1000;
  throbMarks.push(now);
  timestamps.push({ time: now.toFixed(2), bpm: heartRate });
  updatePulse(heartRate);
};

document.getElementById('downloadBtn').onclick = () => {
  const csv = 'Time (s),Heart Rate (BPM)\n' +
    timestamps.map(t => `${t.time},${t.bpm}`).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'migraine_trace.csv';
  a.click();
};

function interpolatePulse(time) {
  const before = pulseData.findLast(p => p.t <= time);
  const after = pulseData.find(p => p.t > time);
  if (!before || !after) return heartRate;
  const ratio = (time - before.t) / (after.t - before.t);
  return before.v + ratio * (after.v - before.v);
}
</script>

</body>
</html>
